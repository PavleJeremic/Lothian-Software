\documentclass[11pt, oneside]{article}   	% use "amsart" instead of "article" for AMSLaTeX format
\usepackage{geometry}                		% See geometry.pdf to learn the layout options. There are lots.
\geometry{letterpaper}                   		% ... or a4paper or a5paper or ... 
%\geometry{landscape}                		% Activate for for rotated page geometry
%\usepackage[parfill]{parskip}    		% Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}				% Use pdf, png, jpg, or epsÂ§ with pdflatex; use eps in DVI mode
								% TeX will automatically convert eps -- pdf in pdflatex		
\usepackage{amssymb}
\graphicspath{ {images/} }

\usepackage{mathtools}
\usepackage{enumitem}
\usepackage{setspace}
\usepackage{sidecap}

\usepackage{url}
\urlstyle{same}

\usepackage{listings}
\usepackage{color}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{frame=tb,
  language=Python,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3
}


\title{BME88A: EKG Final Design Report}
\author{Eduardo Hirata, Henry Hinton, Pavle Jeremic}
%\date{}							% Activate to display a given date or no date

\begin{document}
\maketitle

\pagebreak
\section{Overview}
	
	\onehalfspace

\par An electrocardiogram, also known as EKG or ECG, is a noninvasive device that monitors electrical activity produced by the natural electrical system caused by the contraction of heart muscle. This process of depolarization and repolarization causes allows the heart to pump blood through the body. The electrical impulses generated by each heartbeat are registered by the EKG's electrodes and translated by the device into a waveform. Analysis of this waveform by personnel with requisite training can be used to assess heart condition.
 
 	\sidecaptionvpos{figure}{c}

\begin{SCfigure}[][htb!]
	\includegraphics[width=0.4\textwidth]{ecg}
	\caption{Various positions for 3-lead EKG electrodes. Observe that the ground is not along the path of the electrical signal between the two charged electrodes. \cite{ecgpos} Image copied from RTBoard, \textit{Electrocardiography Devices}.}
\end{SCfigure}

\par Our design uses three electrodes to measure the electrical activity produced by the heart. By positioning two of the electrodes across the heart and the remaining one elsewhere on the body (not in between the two measuring electrodes) as a reference ground, we can generate a voltage across the skin over the heart as seen in Fig.1 . The resulting difference will be small, however, so we need an instrumentation amplifier to provide gain to render the signal interpretable. This amplified signal will be sent to an Arduino (Sparkfun Redboard). When connected to a computer, the Arduino's serial input can be recorded, filtered, and graphed.

\pagebreak

\section{PQRST}

\begin{SCfigure}[][htb!]
	\includegraphics[width=0.4\textwidth]{PQRST}
	\caption{Schematic representation of an EKG reading.  The QRS complex represents the ventricular depolarization and contraction of the heart chambers. \cite{wikiimage} Image copied from Wikipedia article on Electrocardiography.}
\end{SCfigure}
	\onehalfspace

\par For this design we are looking to record the electrical signal of the heartbeat's QRS complex. The QRS complex is the combination of the three main graphical deflections observed on the electrocardiogram produced after the P and T wave as seen in Figure 2. The P wave is the first short upward spike recorded in an ECG, and indicates the contraction of atria that pump blood into the ventricles. The QRS represents the ventricular depolarization and contraction, and it is graphed as a downward deflection, Q; a high upward deflection, spike R, and another downward S wave. Physiologically normal interval durations within the PQRST process happen quickly, in the order of tens of milliseconds. We expect a normal QRS interval to last around 60ms. Overall, we are looking for the electrical signal produced by the heart's contractions; these should be around 0.5mV (before analog amplification). \cite{karptalk} 

\par 
Due to variability in the signal baseline as a direct result of autonomous muscle contraction, however, we must process the baseline with a bandpass filter. \cite{karptalk} Doing this in software will require post-processing (filtering the data after it has been collected), which we are currently achieving using the scipython bandpass filter module and the scipython notch filter. A bandpass filter is designed to remove any frequencies above frequency B $(f_B)$ and below frequency A $(f_A)$ where $f_A < f_B$. For the EKG, a bandwidth from 0.8 to 100 Hz is optimal, as those parameters represent the normal range of the human heartbeat frequency (48 bpm to 180 bpm respectively), and include the diagnostically relevant higher frequency features of the EKG waveform. The heartbeat of a human could be determined with a bandpass of approximately 0.8 to 3.0 Hz, but the diagnostically-relevant peak intervals would be expunged by such a filter. The notch filter is an inversion of the bandpass filter in that it will remove any frequencies between $f_A$ and $f_B$. In the EKG, the notch filter will be used to remove the 60Hz noise produced by inductive capacitance of the surrounding (mains-level) electronics. Both filters will be imported from the SciPython module. \cite{SciPython}    

The final data set will be fed into a graphing program, which will then output data to two modules: the Graphic User Interface (GUI) Module and the Diagnostic Reader Module (DRM). The DRM will provide basic heart rhythm analysis, which will then output to the GUI. The GUI will be a highly-simplified interface that will allow the user to change some of the parameters of the program to improve usability, possibly including bandpass filter parameter alterations to better serve the needs of the user.
\pagebreak

\section{Circuit Design}
\begin{figure}[htb!]
\centering
\includegraphics[width=\textwidth]{blockdiagnew}
\end{figure}
\begin{itemize}[leftmargin=*]
\subsection{Components}
		\item[] \textbf{Circuit Parts:}
			\begin{itemize} 
				\item Universal ECG EKG Electrodes Electrodes
				\item Sparkfun Redboard Arduino
				\item INA122 Instrumentation Amplifier
					\begin{itemize}
						\item CF14JT200K Resistor(R5:200 kOhm)
					\end{itemize} 
				\item LT1354 Operational Amplifier
					\begin{itemize}
						\item CF14JT1K00 Resistor(R2:1 kOhm)
						\item PR01000103003JR500 Resistor(R3:300 kOhm)
					\end{itemize}
				\item DC Filter
					\begin{itemize}
						\item C330C124KCR5TA Capacitor(C1: .12 (MICRO)Farad)
						\item MRS25000C8253FRP00 Resistor (R1:825 kOhm)
						\item HVR2500001004FR500 Resistor (R4:1 Mohm)
					\end{itemize}
				\item Wires
			\end{itemize}
\subsection{Modules}
\item[] \textbf{Hardware Modules:}\\
	Human: Only prerequisite is a beating heart (and consent).\\
	Instrumentation Amplifier: Voltage fluctuations may be lower than the Arduino's resolution ($\geq$5mV), so we must use the amplifier to boost the signal to a level we can monitor. Since the signal will be approximately 0.5 mV but the DC noise could be as high as 300 mV \cite{karptalk}, the instrumentation amplifier could be saturated by a boosted noise signal. As such, the primary purpose of the instrumentation amplifier will be to "convert [a] differential signal to [a] single-ended signal referenced to V{ref}" \cite{karptalk}, rather than to boost the voltage. Since the gain function of the INA122 is the folowing: 
	\begin{equation}
	Gain = 5 + \frac{200kOhm}{R{Gain}}
	\end{equation}
	It was determined that a safe gain would be 6X, corresponding to a R{Gain} of 200 kOhm.\\
	Arduino: Converts analog input to digital output for Laptop using a serial output.\\
	Computer: Runs software/code and displays data. 
	
\item[] \textbf{Software Modules:}
	\begin{itemize}
	\item Register: Generates a list of voltage differential values and time recorded, pairing the two values.
	\item Noise Filters:
		\begin{itemize}
		\item Bandpass Filter: Removes noisy frequencies higher and lower than the target bandwidth, imported from SciPython. \cite{SciPython}
		\item Notch Filter: Removes ~60 Hz noise generated by surrounding electronics.
		\end{itemize}  
	\item Grapher: Plots all data points and connects to generate EKG waveform, imported from matplotlib \cite{matplotlib}
	\item GUI: Basic interface with ability to change graphing options and potentially activate/disable diagnostic screening or change diagnostic parameters manually.
	\end{itemize}
\item[] \textbf{Hypothetical Software Module:}
	Diagnostic: Determines average distance between waveform peaks. 
\end{itemize}

\section{Current Design Plans}
We plan on using a Texas Instruments INA122PA-ND instrumentation amplifier to find the differential signal from our electrodes, as mentioned above the gain will be minimized to 6X in order to not saturate the INA122. \cite{INA122PA-ND} The LT1354 Operational amplifier will provide most of the voltage gain at approximately 300X voltage gain.



\section{Cost}
These are the fiscal costs associated with this project, not including man hours. The following assumes that a USB cable and a laptop is available to the reader. Ordering extras is highly recommended.\\

\noindent \textbf{Sparkfun Redboard:} \hfill \$20\\
\textbf{Breadboard TW-E40-1020:} \hfill \$8.98\\
\textbf{Wires:} \hfill \$4.95\\
\textbf{Texas Instruments INA122PA-ND:}  \hfill \$6.35 (3X)\\
\textbf{LT1354 Operational Amplifier:} \hfill \$4.27 (3X)\\
\textbf{Capacitor:} \hfill \$2.64 (3X)\\
\textbf{MRS25000C8253FRP00 Resistor:} \hfill\$0.44 (3X)\\
\textbf{HVR2500001004FR500 Resistor:} \hfill\$0.47 (3X)\\
\textbf{CF14JT1K00 Resistor:} \hfill\$0.10 (3X)\\
\textbf{PR01000103003JR500 Resistor:} \hfill\$0.37 (3X)\\
\textbf{CF14JT200K Resistor:} \hfill \$0.10\\
\textbf{Electrodes:} Provided by Dr. Karplus \hfill\$0.00\\
\rule{\textwidth}{1pt}
\textbf{Total Cost:} \hfill Including Shipping/Markup: \$59.61\\
\pagebreak

\section{Code}
\begin{lstlisting}

'''
Created on Mar 8, 2015

@author: Henry Hinton, Pavle Jeremic, Eduardo Hirata
'''
#import required modules
from sys import argv
import numpy
import scipy
import matplotlib.pyplot as plt
#arrays to store values
time = []
vol = []
#read filename from terminal input
filename = argv[1]
#open file
txt = open(filename, 'r')
print('Using file: ' + filename) #verify filename with user
for line in txt: #skip commented lines in data file
    if line.startswith('#'):
        continue
    fields = map(float, line.split()) #create tuple with time and values
    if len(fields) >= 2: #verify tuple
        time.append(fields[0])
        vol.append(fields[1])
print("Using %d values" % len(time)) #show number of data points

for i in range (0, len(time)):
    print("%.7f  %.7f" % (time[i], vol[i])) #print data to terminal
plt.plot(time, vol) #use matplotlib to plot data

plt.show() #open window with plot
txt.close() #close the file safely
\end{lstlisting}
\pagebreak
\par The above code is our current graphing module that has successfully converted the example data provided by Dr. Karplus \cite{karptalk} and generated a waveform as seen in Figure 3. In the next two days we will implement the bandpass and notch filters from scipy. Immediately afterwards we plan on completing the Diagnostic Module and a GUI. Current plans indicate that we will most likely import GUI functionality from the matplotlib module due to time constraints.

\begin{SCfigure}[][htb!]
	\includegraphics[width=0.5\textwidth]{matplotlib1}
	\caption{image of raw EKG waveform with no software filtering, generated from static data provided by Dr. Karplus \cite{karptalk}. It is immediatly apparent that the unfiltered signal is almost useless for data extraction without further filtering.}
\end{SCfigure}


\pagebreak
\begin{thebibliography}{14}

\bibitem{ecgpos}
"Electrocardiography Devices." Electrocardiography Devices. N.p., n.d. Web. 24 Feb. 2015. \\ \url{http://rtboardreview.com/public/equipment_room/ats_ecg.htm}

\bibitem{wikiimage}
Cardiac Waveform. Digital image. Electrocardiogram. \textit{Wikipedia}, n.d. Web. 24 Feb. 2015. \\ \url{http://en.wikipedia.org/wiki/Electrocardiography#mediaviewer/File:QRS_complex.png}.

\bibitem{howtoread}
"How to Read an Electrocardiogram (ECG). Part One: Basic Principles of the ECG. The Normal ECG." N.p., n.d. Web. 24 Feb. 2015. \\ \url{http://www.southsudanmedicaljournal.com/archive/may-2010/how-to-read-an-electrocardiogram-ecg.-part-one-basic-principles-of-the-ecg.-the-normal-ecg.html}.

\bibitem{karplus}
Karplus, Kevin. "Two-Stage EKG." Web log post. Gasstationwithoutpumps. Wordpress, 14 July 2012. Web. 17 Feb. 2015. \\ \url{https://gasstationwithoutpumps.wordpress.com/2012/07/14/two-stage-ekg/}.

\bibitem{karptalk}
Personal communication with Dr. Karplus regarding typical EKG sensor output.

\bibitem{INA122PA-ND}
Data sheet for Texas Instruments INA122PA-ND instrumentation amplifier. Web. March 1, 2015.\\ \url{http://www.ti.com/lit/ds/symlink/ina122.pdf}

\bibitem{SciPython}
Eric Jones and Travis Oliphant and Pearu Peterson and others. SciPy: Open source scientific tools for Python, 2001-present.March 1, 2015
\url{http://www.scipy.org/"}

\bibitem{matplotlib}
Hunter, J. D. Matplotlib: A 2D graphics enviroment.
Computing in Science \& Engineering vol.9 \#3 pg. 90-95
publisher: IEEE Computer Society, 2007. \url{http://matplotlib.org/index.html}



\end{thebibliography}

\end{document}  